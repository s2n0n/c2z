apiVersion: v1
kind: ConfigMap
metadata:
  name: academy-lms-db-init
  namespace: simulation
data:
  init.sql: |
    -- Initialize database for Academy LMS
    CREATE DATABASE IF NOT EXISTS `academy_lms` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
    USE `academy_lms`;
    
    -- Create initial admin user (for testing)
    -- Password: admin (MD5 hashed)
    CREATE TABLE IF NOT EXISTS `users` (
      `id` int(11) NOT NULL AUTO_INCREMENT,
      `username` varchar(100) NOT NULL,
      `password` varchar(255) NOT NULL,
      `email` varchar(100) NOT NULL,
      `role` varchar(50) NOT NULL DEFAULT 'student',
      `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    
    INSERT INTO `users` (`username`, `password`, `email`, `role`) VALUES
    ('admin', '21232f297a57a5a743894a0e4a801fc3', 'admin@academy-lms.local', 'admin'),
    ('instructor', '5b6f8c5c4c5c0c5c4c5c0c5c4c5c0c5c', 'instructor@academy-lms.local', 'instructor'),
    ('student', 'cd73502828457d15655bbd7a63fb0bc8', 'student@academy-lms.local', 'student');

---
apiVersion: v1
kind: Pod
metadata:
  name: cve-2025-56749
  namespace: simulation
  labels:
    app: cve-2025-56749
spec:
  imagePullSecrets:
    {{- toYaml .Values.global.imagePullSecrets | nindent 4 }}
  
  # Init container to wait for MariaDB to be ready
  initContainers:
  - name: wait-for-db
    image: busybox:latest
    command: ['sh', '-c', 'echo "Waiting for MariaDB to initialize..."; sleep 20; echo "MariaDB should be ready now"']
  
  # Multi-container Pod: MariaDB + Academy LMS Web Application
  containers:
  # Container 1: MariaDB Database
  - name: mariadb
    image: mariadb:10.5
    env:
    - name: MYSQL_DATABASE
      value: "academy_lms"
    - name: MYSQL_ROOT_PASSWORD
      value: "root"
    - name: MYSQL_ALLOW_EMPTY_PASSWORD
      value: "no"
    ports:
    - containerPort: 3306
      name: mysql
    volumeMounts:
    - name: db-init-script
      mountPath: /docker-entrypoint-initdb.d
      readOnly: true
  
  # Container 2: Academy LMS Web Application (CodeIgniter 3 PHP)
  - name: academy-lms-web
    image: ghcr.io/s2n0n/c2z/cve-2025-56749-academy-lms:latest
    ports:
    - containerPort: 80
      name: http
    env:
    - name: DB_HOST
      value: "localhost"
    - name: DB_USER
      value: "root"
    - name: DB_PASS
      value: "root"
    - name: DB_NAME
      value: "academy_lms"
  
  volumes:
  - name: db-init-script
    configMap:
      name: academy-lms-db-init