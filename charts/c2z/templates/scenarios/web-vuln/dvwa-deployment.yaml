{{- if .Values.scenarios.webVuln.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dvwa
  namespace: traffic-analysis
  labels:
    app: dvwa
    scenario: web-vuln
spec:
  replicas: {{ .Values.scenarios.webVuln.dvwa.replicas }}
  selector:
    matchLabels:
      app: dvwa
  template:
    metadata:
      labels:
        app: dvwa
        scenario: web-vuln
    spec:
      # ===== 추가: 프로세스 네임스페이스 공유 =====
      shareProcessNamespace: true

      containers:
      # ===== 기존 DVWA 컨테이너 =====
      - name: dvwa
        image: {{ .Values.scenarios.webVuln.dvwa.image }}
        ports:
        - containerPort: 80
          name: http
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "dvwa"
        - name: MYSQL_DATABASE
          value: "dvwa"
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        # ===== 추가: PCAP 볼륨 마운트 =====
        volumeMounts:
        - name: pcap-storage
          mountPath: /pcaps
          readOnly: true
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 5

      # ===== 추가: Packet Capture Sidecar =====
      - name: packet-capture
        image: nicolaka/netshoot:latest
        command:
        - /bin/sh
        - /scripts/capture.sh
        env:
        - name: INTERFACE
          value: "eth0"
        - name: PCAP_DIR
          value: "/pcaps"
        - name: ROTATION_SIZE
          value: "50"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        volumeMounts:
        - name: pcap-storage
          mountPath: /pcaps
        - name: capture-script
          mountPath: /scripts
      
      # ===== 추가: 볼륨 정의 =====
      volumes:
      - name: pcap-storage
        persistentVolumeClaim:
          claimName: pcap-storage
      - name: capture-script
        configMap:
          name: packet-capture-script
          defaultMode: 0755
{{- end }}